<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Betslip - Smart Bet Slip</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        @media print {
            .no-print {
                display: none !important;
            }
            body {
                background: white;
                padding: 0;
            }
            .card {
                border: none !important;
                box-shadow: none !important;
            }
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
            padding: 1rem;
        }
        
        #betslip {
            background-color: #fff;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }
        .bet-item {
            margin-bottom: 1rem;
            padding: 1.25rem;
            background-color: #f8f9fa;
            border-radius: 0.5rem;
            border-left: 4px solid #0d6efd;
            transition: all 0.2s ease;
        }
        
        .bet-item:hover {
            transform: translateX(4px);
            box-shadow: 0 0.125rem 0.5rem rgba(0, 0, 0, 0.1);
        }
        
        .bet-league {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
        }
        
        .bet-teams {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .bet-market {
            font-size: 0.9rem;
            color: #495057;
            margin-bottom: 0.5rem;
        }
        
        .bet-odds {
            display: inline-block;
            background-color: #0d6efd;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .total-odds {
            font-size: 1.5rem;
            font-weight: 700;
            color: #0d6efd;
        }
        li strong {
            color: #333;
            display: block;
            margin-bottom: 5px;
            font-size: 1.05em;
        }
        .total-odds {
            font-size: 1.3em;
            font-weight: bold;
            margin: 25px 0 15px;
            padding: 15px;
            background-color: #f0f8ff;
            border-radius: 8px;
            text-align: center;
            border: 1px dashed #4a90e2;
        }
        .download-btn {
            display: block;
            margin: 30px auto 10px;
            padding: 12px 30px;
            background-color: #ff7300;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(255, 115, 0, 0.3);
        }
        .download-btn:hover {
            background-color: #e56600;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 115, 0, 0.4);
        }
        .download-btn:active {
            transform: translateY(0);
        }
        .match-info {
            color: #555;
            font-size: 0.95em;
            line-height: 1.5;
        }
        .match-info span {
            display: inline-block;
            margin-right: 15px;
        }
        .match-info .odds {
            float: right;
            background-color: #4a90e2;
            color: white;
            padding: 2px 10px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 0.9em;
        }
        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            #betslip {
                padding: 20px;
                width: 100%;
            }
            .match-info span {
                display: block;
                margin: 5px 0;
            }
            .match-info .odds {
                float: none;
                display: inline-block;
                margin-top: 5px;
            }
        }
    </style>
</head>
<body class="bg-light">
    <div class="container py-4">
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body p-4">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4">
                    <div class="mb-3 mb-md-0">
                        <h1 class="h3 mb-1">Your Bet Slip</h1>
                        <p class="text-muted mb-0">Generated on {{ slip.created_at.strftime('%B %d, %Y at %H:%M') }}</p>
                    </div>
                    <div class="btn-group">
                        <button onclick="window.print()" class="btn btn-outline-secondary">
                            <i class="bi bi-printer"></i> Print
                        </button>
                        <button onclick="downloadSlipAsImage()" class="btn btn-primary">
                            <i class="bi bi-download"></i> Save as Image
                        </button>
                    </div>
                </div>
                
                <div id="betslip">
                    <div class="bets-list">
                        {% if slip.matches and slip.matches is iterable %}
                            {% for match in slip.matches %}
                                <div class="bet-item">
                                    <div class="bet-league">{{ match.league or 'Match' }}</div>
                                    <div class="bet-teams">{{ match.match or 'Home Team vs Away Team' }}</div>
                                    <div class="bet-market">
                                        <strong>{{ match.market or 'Market' }}:</strong> {{ match.pick or 'Pick' }}
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="small text-muted">
                                            <i class="bi bi-calendar3"></i> {{ match.date or 'Date' }}
                                        </span>
                                        <span class="bet-odds">{{ "%.2f"|format(match.odds|float) if match.odds else 'N/A' }}</span>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="alert alert-warning mb-0">No matches found for this betslip.</div>
                        {% endif %}
                    </div>
                    
                    {% if total_odds is not none %}
                        <div class="total-odds">
                            🔢 Total Combined Odds: {{ "%.2f"|format(total_odds) }}
                        </div>
                    {% endif %}
                </div>
                
                <div class="alert alert-info no-print mt-4">
                    <div class="d-flex">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        <div>
                            <strong>Tip:</strong> Save or print this betslip for your records. 
                            You can also take a screenshot using the "Save as Image" button above.
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Post-Submit Ads -->
        {% if ads %}
        <div class="mt-5">
            {% include 'includes/_post_submit_ads.html' %}
        </div>
        {% endif %}
    </div>

    <button class="download-btn" onclick="downloadSlipAsImage()">
        📥 Download as Image
    </button>

    <script>
    function downloadSlipAsImage() {
        const button = event.target;
        const originalText = button.textContent;
        
        // Show loading state
        button.disabled = true;
        button.textContent = '⏳ Preparing...';
        
        // Add timestamp to filename
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-')
        const filename = `betslip-${timestamp}.png`;
        
        // Capture the betslip
        const slip = document.getElementById("betslip");
        
        html2canvas(slip, {
            scale: 2, // Higher quality
            logging: false,
            useCORS: true,
            allowTaint: true,
            backgroundColor: '#ffffff'
        }).then(canvas => {
            // Create download link
            const link = document.createElement('a');
            link.download = filename;
            link.href = canvas.toDataURL('image/png');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Revert button state
            button.textContent = '✅ Downloaded! Click to download again';
            setTimeout(() => {
                button.textContent = originalText;
                button.disabled = false;
            }, 2000);
            
        }).catch(error => {
            console.error('Error generating image:', error);
            button.textContent = '❌ Error! Click to try again';
            setTimeout(() => {
                button.textContent = originalText;
                button.disabled = false;
            }, 2000);
        });
    }
    </script>
</body>
</html>
