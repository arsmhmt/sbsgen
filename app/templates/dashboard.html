<!-- templates/dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SmartSlip AI Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f9f9f9; }
    .card { border: none; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .betslip-preview { background: #fff; padding: 1rem; border-radius: .5rem; }
  </style>
</head>
<body>
<div class="container py-4">
  <div class="alert alert-info d-flex justify-content-between align-items-center">
    <span>{% set credit_text = 'You have <strong id="creditCount">--</strong> free betslips left today.' %}{{ get_text(credit_text, lang) | safe }}</span>
    <a href="/pricing" class="btn btn-sm btn-outline-success">{{ get_text('Upgrade to Pro', lang) }}</a>
  </div>
  <div class="text-center mb-4">
    <h1 class="fw-bold">{{ get_text('SmartSlip AI', lang) }}</h1>
    <p class="text-muted">{{ get_text('Select sports, leagues, and generate a smart betslip with AI-backed win prediction.', lang) }}</p>
  </div>

  <form id="betslipForm">
    <div class="row g-3 mb-3">
      <div class="col-md-4">
        <label for="sportSelect" class="form-label">{{ get_text('Sports', lang) }}</label>
        <select class="form-select" id="sportSelect" multiple></select>
      </div>
      <div class="col-md-4">
        <label for="leagueSelect" class="form-label">{{ get_text('Leagues', lang) }}</label>
        <select class="form-select" id="leagueSelect" multiple></select>
      </div>
      <div class="col-md-4">
        <label for="matchCount" class="form-label">{{ get_text('# Matches', lang) }}</label>
        <input type="number" class="form-control" id="matchCount" min="1" value="5">
      </div>
    </div>
    <div class="d-grid gap-2 mb-4">
      <button type="submit" class="btn btn-primary btn-lg">ðŸŽ¯ {{ get_text('Generate Smart Betslip', lang) }}</button>
    </div>
  </form>

  <div class="card mb-4">
    <div class="card-header">
      <strong>{{ get_text('Generated Betslip', lang) }}</strong>
    </div>
    <div class="card-body betslip-preview" id="betslipPreview">
      <div class="text-muted">{{ get_text('Your betslip will appear here...', lang) }}</div>
    </div>
    <div class="card-footer d-flex justify-content-between text-muted small">
      <div>{{ get_text('Total Odds', lang) }}: <span id="totalOdds">--</span></div>
      <div>{{ get_text('Win Probability', lang) }}: <span id="winProb">--%</span></div>
    </div>
  </div>

  <!-- Smart Analytics Section -->
  <div class="card mb-4">
    <div class="card-header">
      <strong>{{ get_text('Bet Success Analytics', lang) }}</strong>
    </div>
    <div class="card-body">
      <canvas id="successChart" height="120"></canvas>
      <div class="mt-3">
        <strong>{{ get_text('Your Win %', lang) }}:</strong> <span id="userWinPct">--</span>%
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">
      <strong>{{ get_text('Recent Betslips', lang) }}</strong>
    </div>
    <div class="card-body" id="recentBetslipsContainer">
      <ul class="list-group list-group-flush" id="recentBetslipList"></ul>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  // Load success ratio chart and user win %
  axios.get("/api/betslip-analytics").then(res => {
    const ctx = document.getElementById("successChart").getContext("2d");
    new Chart(ctx, {
      type: "line",
      data: {
        labels: res.data.dates,
        datasets: [{
          label: "Success Ratio",
          data: res.data.success_ratios,
          borderColor: "#198754",
          backgroundColor: "rgba(25,135,84,0.1)",
          fill: true
        }]
      },
      options: {
        scales: { y: { min: 0, max: 100 } },
        plugins: { legend: { display: false } }
      }
    });
    document.getElementById("userWinPct").innerText = res.data.user_win_pct ?? "--";
  });
  axios.get("/api/credit-info").then(res => {
    document.getElementById("creditCount").innerText = res.data.remaining;
  });
  const sportSelect = document.getElementById("sportSelect");
  const leagueSelect = document.getElementById("leagueSelect");
  const preview = document.getElementById("betslipPreview");
  const totalOddsEl = document.getElementById("totalOdds");
  const winProbEl = document.getElementById("winProb");

  // Load recent betslips
  async function loadRecentBetslips() {
    const res = await axios.get('/api/recent-betslips');
    const list = document.getElementById('recentBetslipList');
    list.innerHTML = "";

    if (res.data.length === 0) {
      list.innerHTML = `<li class='list-group-item text-muted'>{{ get_text('No recent betslips found.', lang) }}</li>`;
      return;
    }

    res.data.forEach(slip => {
      const li = document.createElement("li");
      li.className = "list-group-item d-flex justify-content-between align-items-center";
      li.innerHTML = `
        <div>
          <strong>Odds:</strong> ${slip.total_odds.toFixed(2)} <br>
          <strong>Win %:</strong> ${slip.win_probability.toFixed(1)}%
        </div>
        <small class="text-muted">${new Date(slip.created_at).toLocaleString()}</small>
      `;
      list.appendChild(li);
    });
  }

  async function loadSports() {
    const res = await axios.get("/api/sports");
    res.data.forEach(s => {
      const option = new Option(s.name, s.key);
      sportSelect.appendChild(option);
    });
  }

  async function loadLeagues(sportKey) {
    const res = await axios.get(`/api/leagues/${sportKey}`);
    leagueSelect.innerHTML = "";
    res.data.forEach(l => {
      const option = new Option(`${l.league.name} (${l.country.name})`, l.league.id);
      leagueSelect.appendChild(option);
    });
  }

  sportSelect.addEventListener("change", () => {
    const selected = Array.from(sportSelect.selectedOptions).map(o => o.value);
    if (selected.length === 1) {
      loadLeagues(selected[0]);
    } else {
      leagueSelect.innerHTML = "<option disabled>Select 1 sport to load leagues</option>";
    }
  });

  document.getElementById("betslipForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const leagues = Array.from(leagueSelect.selectedOptions).map(o => parseInt(o.value));
    const matchCount = parseInt(document.getElementById("matchCount").value);
    const res = await axios.post("/api/betslip", { leagues, match_count: matchCount });
    
    preview.innerHTML = res.data.slip.map(m =>
      `<div><strong>${m.home} vs ${m.away}</strong> â€“ ${m.market} @ ${m.odds}</div>`
    ).join("");

    totalOddsEl.innerText = res.data.total_odds;
    winProbEl.innerText = `${res.data.win_probability}%`;
  });

  loadSports();
  loadRecentBetslips();
});
</script>
</body>
</html>
